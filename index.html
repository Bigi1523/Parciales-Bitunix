<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Parciales Bitunix</title>

<meta name="theme-color" content="#0b1220">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Parciales">

<link rel="manifest" href="manifest.webmanifest">
<link rel="apple-touch-icon" href="icon-180.png">

<style>
  body{background:#0b1220;color:#e5e7eb;font-family:system-ui;padding:20px;margin:0;}
  .box{max-width:420px;margin:auto;background:#0f172a;border-radius:14px;padding:18px;}
  h1{font-size:16px;margin:0 0 12px;}

  label{font-size:12px;color:#9ca3af;}

  input{
    width:100%;margin:6px 0 12px;padding:12px;border-radius:12px;border:none;
    background:#020617;color:#fff;font-size:16px;
    outline:none;
  }
  input::placeholder{color:#475569;}
  input.warn{ box-shadow: 0 0 0 2px rgba(239,68,68,.55) inset; }

  .seg{display:flex; gap:10px; margin:8px 0 14px; align-items:stretch;}

  /* Botón base */
  .btn{
    flex:1; padding:12px; border-radius:12px;
    border:1px solid #1f2937;
    background:#0b1220; color:#e5e7eb;
    cursor:pointer; user-select:none; text-align:center;
    font-weight:800;
  }
  .btn.active{
    background:#1f2937;
    border-color:#334155;
    box-shadow: 0 0 0 1px rgba(148,163,184,.25) inset;
  }

  /* Short/Long: colores */
  .btn.short{ background:#1a0b0b; border-color:#3b1a1a; }
  .btn.long{  background:#0b1a10; border-color:#1a3b24; }

  .btn.short.active{
    background:#7f1d1d;
    border-color:#ef4444;
    box-shadow: 0 0 0 1px rgba(239,68,68,.25) inset;
  }
  .btn.long.active{
    background:#166534;
    border-color:#22c55e;
    box-shadow: 0 0 0 1px rgba(34,197,94,.25) inset;
  }

  /* Custom margin input inline */
  .miniInput{
    flex:1;
    margin:0;
    padding:12px;
    border-radius:12px;
    border:1px solid #1f2937;
    background:#020617;
    color:#fff;
    font-size:16px;
    min-width:0;
  }
  .miniInput::placeholder{color:#475569;}
  .miniInput.activeCustom{
    border-color:#60a5fa;
    box-shadow: 0 0 0 1px rgba(96,165,250,.35) inset;
  }

  .result{background:#020617;border-radius:12px;padding:14px;margin-top:10px;}
  .small{font-size:12px;color:#9ca3af;}
  .big{font-size:22px;font-weight:900; font-variant-numeric: tabular-nums;}
  .hint{font-size:12px;color:#9ca3af;margin-top:10px;line-height:1.35;}

  .tp{color:#22c55e;}
  .sl{color:#ef4444;}
  .pos{color:#22c55e;}
  .neg{color:#ef4444;}
  .muted{color:#9ca3af;}

  .row{display:flex; gap:10px; align-items:stretch;}
  .copyBtn{
    padding:12px;
    border-radius:12px;
    border:1px solid #1f2937;
    background:#0b1220;
    color:#e5e7eb;
    font-weight:900;
    cursor:pointer;
    white-space:nowrap;
  }
  .copyBtn:active{transform:scale(0.99);}
  .toast{
    margin-top:8px;
    font-size:12px;
    color:#a7f3d0;
    min-height:16px;
  }

  /* TP/SL card with pnl on the right */
  .line2{
    display:flex;
    justify-content:space-between;
    align-items:flex-end;
    gap:12px;
  }
  .line2 .left{
    min-width:0;
  }
  .line2 .right{
    text-align:right;
    white-space:nowrap;
    font-variant-numeric: tabular-nums;
  }
  .pnlTag{
    font-size:12px;
    color:#9ca3af;
    margin-bottom:4px;
  }
  .pnlVal{
    font-size:18px;
    font-weight:900;
  }

  /* ======= NUEVO: copiar TP/SL tocando el precio (con icono chico) ======= */
  .copyVal{
    display:inline-flex;
    align-items:baseline;
    gap:8px;
    cursor:pointer;
    user-select:none;
  }
  .copyVal:active{transform:scale(.995)}
  .copyIco{
    font-size:14px;
    opacity:.65;
    line-height:1;
  }
</style>
</head>

<body>
<div class="box">
  <h1>Parciales (Bitunix)</h1>

  <label>Lado</label>
  <div class="seg" id="sideSeg">
    <div class="btn short active" data-side="short">Short</div>
    <div class="btn long" data-side="long">Long</div>
  </div>

  <label>Precio de entrada</label>
  <input id="entry" type="number" inputmode="decimal" step="0.0001" placeholder="Ej: 223.59">

  <label>Margen (USDT)</label>
  <!-- 3 en una línea: 50 / 75 / custom -->
  <div class="seg" id="marginRow" style="margin-top:6px;">
    <div class="btn active" id="m50" data-margin="50">50</div>
    <div class="btn" id="m75" data-margin="75">75</div>
    <input class="miniInput" id="mCustom" type="number" inputmode="decimal" step="0.01" placeholder="Custom">
  </div>

  <label>Estrategia</label>
  <div class="seg" id="modeSeg">
    <div class="btn active" data-mode="ema8">EMA8</div>
    <div class="btn" data-mode="boll">Bollinger</div>
  </div>

  <div class="result" style="margin-top:6px;">
    <div class="small">Regla activa</div>
    <div class="big" id="ruleBadge">—</div>
  </div>

  <div class="result">
    <div class="small">Qty a cerrar (COPIAR EN BITUNIX)</div>
    <div class="row" style="margin-top:8px;">
      <div class="big" id="qtyClose" style="flex:1;">—</div>
      <button class="copyBtn" id="copyQtyBtn" type="button">Copiar Qty</button>
    </div>
    <div class="toast" id="toast"></div>
  </div>

  <div class="result" id="tpCard">
    <div class="small">TP (limit) <span class="tp">TP</span></div>
    <div class="line2" style="margin-top:6px;">
      <div class="left">
        <!-- NUEVO: envoltorio clicable -->
        <div class="big copyVal" id="tpCopy">
          <span id="tpPrice">—</span>
          <span class="copyIco" aria-hidden="true">⧉</span>
        </div>
      </div>
      <div class="right">
        <div class="pnlTag">PnL neto</div>
        <div class="pnlVal" id="tpPnl">—</div>
      </div>
    </div>
    <div class="small muted" id="tpNote" style="margin-top:6px;">TP PnL = cierre del parcial</div>
  </div>

  <div class="result" id="slCard">
    <div class="small">SL (stop) <span class="sl">SL</span></div>
    <div class="line2" style="margin-top:6px;">
      <div class="left">
        <!-- NUEVO: envoltorio clicable -->
        <div class="big copyVal" id="slCopy">
          <span id="slPrice">—</span>
          <span class="copyIco" aria-hidden="true">⧉</span>
        </div>
      </div>
      <div class="right">
        <div class="pnlTag">PnL neto</div>
        <div class="pnlVal" id="slPnl">—</div>
      </div>
    </div>
    <div class="small muted" id="slNote" style="margin-top:6px;">SL PnL = cierre 100%</div>
  </div>

  <div class="hint" id="modeHint">—</div>
</div>

<script>
  // === Config estrategia ===
  const MODES = {
    ema8: { tpPct: 0.4, slPct: 0.4, partialPct: 60, lev: 30 },
    boll: { tpPct: 0.6, slPct: 0.5, partialPct: 50, lev: 20 }
  };

  // Fee fijo Bitunix (peor caso) - ida+vuelta total (%)
  // (sin mostrarlo en UI)
  const FEE_ROUNDTRIP_PCT = 0.06; // 0.06%

  let state = { side: "short", margin: 50, customMargin: 0, mode: "ema8" };

  const entryEl   = document.getElementById("entry");
  const qtyCloseEl= document.getElementById("qtyClose");
  const tpPriceEl = document.getElementById("tpPrice");
  const slPriceEl = document.getElementById("slPrice");
  const tpPnlEl   = document.getElementById("tpPnl");
  const slPnlEl   = document.getElementById("slPnl");
  const hintEl    = document.getElementById("modeHint");
  const ruleBadgeEl = document.getElementById("ruleBadge");
  const copyBtn   = document.getElementById("copyQtyBtn");
  const toastEl   = document.getElementById("toast");

  const m50Btn    = document.getElementById("m50");
  const m75Btn    = document.getElementById("m75");
  const mCustomEl = document.getElementById("mCustom");

  // NUEVO: wrappers para copiar TP/SL
  const tpCopyEl = document.getElementById("tpCopy");
  const slCopyEl = document.getElementById("slCopy");

  function setActive(containerId, attr, value){
    const box = document.getElementById(containerId);
    box.querySelectorAll(".btn").forEach(b=>{
      const v = b.getAttribute(attr);
      b.classList.toggle("active", v === value);
    });
  }

  function fmtNum(x, dec=6){
    if(!Number.isFinite(x)) return "—";
    // mantener simple (punto decimal), pero iOS muestra bien
    return x.toFixed(dec);
  }

  function fmtUSDT(x){
    if(!Number.isFinite(x)) return "—";
    const signClass = x >= 0 ? "pos" : "neg";
    const val = Math.abs(x).toFixed(2);
    return `<span class="${signClass}">${x<0?'-':''}${val} USDT</span>`;
  }

  function getMarginUsed(){
    const cm = parseFloat(mCustomEl.value);
    if (Number.isFinite(cm) && cm > 0) return cm;
    return state.margin;
  }

  // Fee aprox “peor caso” usando notional promedio (entrada+salida)/2 * qty
  function feeOnClose(entry, exit, qty){
    const fee = (FEE_ROUNDTRIP_PCT/100);
    const avgNotional = ((entry + exit) / 2) * qty;
    return avgNotional * fee;
  }

  function calc(){
    const entry = parseFloat(entryEl.value);
    const cfg = MODES[state.mode];
    const marginUsed = getMarginUsed();

    // Badge siempre
    ruleBadgeEl.textContent =
      `${state.mode.toUpperCase()} | TP ${cfg.tpPct}% | SL ${cfg.slPct}% | Parcial ${cfg.partialPct}% | Lev ${cfg.lev}x`;

    // custom highlight
    const cm = parseFloat(mCustomEl.value);
    const customActive = Number.isFinite(cm) && cm > 0;
    mCustomEl.classList.toggle("activeCustom", customActive);

    // Si entrada vacía => guiones
    if(!(entry>0)) {
      qtyCloseEl.textContent = "—";
      tpPriceEl.textContent = "—";
      slPriceEl.textContent = "—";
      tpPnlEl.textContent   = "—";
      slPnlEl.textContent   = "—";
      hintEl.textContent = `Side: ${state.side.toUpperCase()} | Margen: ${marginUsed}`;
      entryEl.classList.remove("warn");
      return;
    }

    // Cálculo base
    const notional = marginUsed * cfg.lev;
    const qtyTotal = notional / entry;
    const qtyClose = qtyTotal * (cfg.partialPct/100);

    // TP/SL precio
    const tpMove = cfg.tpPct/100;
    const slMove = cfg.slPct/100;

    let tpPrice, slPrice;
    if (state.side === "long") {
      tpPrice = entry * (1 + tpMove);
      slPrice = entry * (1 - slMove);
    } else {
      tpPrice = entry * (1 - tpMove);
      slPrice = entry * (1 + slMove);
    }

    // PnL neto (peor caso fee):
    // TP: neto cerrando SOLO qtyClose en tpPrice
    // SL: neto cerrando 100% qtyTotal en slPrice
    const grossTP = (state.side === "long")
      ? qtyClose * (tpPrice - entry)
      : qtyClose * (entry - tpPrice);

    const grossSL = (state.side === "long")
      ? qtyTotal * (slPrice - entry)
      : qtyTotal * (entry - slPrice);

    const feeTP = feeOnClose(entry, tpPrice, qtyClose);
    const feeSL = feeOnClose(entry, slPrice, qtyTotal);

    const netTP = grossTP - feeTP;
    const netSL = grossSL - feeSL;

    qtyCloseEl.textContent = qtyClose.toFixed(6);
    tpPriceEl.textContent  = tpPrice.toFixed(4);
    slPriceEl.textContent  = slPrice.toFixed(4);

    tpPnlEl.innerHTML = fmtUSDT(netTP);
    slPnlEl.innerHTML = fmtUSDT(netSL);

    hintEl.textContent =
      `Side: ${state.side.toUpperCase()} | Margen: ${marginUsed} | Qty total: ${qtyTotal.toFixed(6)}`;

    entryEl.classList.remove("warn");
  }

  async function copyQty(){
    const text = qtyCloseEl.textContent.trim();
    if(text === "—" || !text) return;

    try {
      await navigator.clipboard.writeText(text);
      toastEl.textContent = "✅ Qty copiada";
    } catch (e) {
      const ta = document.createElement("textarea");
      ta.value = text;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand("copy");
      document.body.removeChild(ta);
      toastEl.textContent = "✅ Qty copiada";
    }
    setTimeout(()=> toastEl.textContent = "", 1200);
  }

  // NUEVO: copiar TP/SL al tocar el precio
  async function copyPriceFrom(el){
    const text = (el.textContent || "").trim();
    if(!text || text === "—") return;

    try {
      await navigator.clipboard.writeText(text);
      toastEl.textContent = "✅ Copiado";
    } catch (e) {
      const ta = document.createElement("textarea");
      ta.value = text;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand("copy");
      document.body.removeChild(ta);
      toastEl.textContent = "✅ Copiado";
    }
    setTimeout(()=> toastEl.textContent = "", 1200);
  }

  // === Events ===
  document.getElementById("sideSeg").addEventListener("click", (e)=>{
    const btn = e.target.closest(".btn"); if(!btn) return;
    state.side = btn.dataset.side;
    setActive("sideSeg","data-side", state.side);
    calc();
  });

  // margin buttons
  document.getElementById("marginRow").addEventListener("click", (e)=>{
    const btn = e.target.closest(".btn"); if(!btn) return;
    const v = parseFloat(btn.dataset.margin);
    if(Number.isFinite(v)){
      state.margin = v;
      // si tocas 50/75, NO borramos custom automáticamente (por si lo quieres mantener),
      // pero si custom > 0 seguirá teniendo prioridad.
      setActive("marginRow","data-margin", String(state.margin));
      calc();
    }
  });

  // custom margin override
  mCustomEl.addEventListener("input", ()=>{
    toastEl.textContent="";
    calc();
  });

  document.getElementById("modeSeg").addEventListener("click", (e)=>{
    const btn = e.target.closest(".btn"); if(!btn) return;
    state.mode = btn.dataset.mode;
    setActive("modeSeg","data-mode", state.mode);
    calc();
  });

  entryEl.addEventListener("input", ()=>{ toastEl.textContent=""; calc(); });
  copyBtn.addEventListener("click", copyQty);

  // NUEVO: click/tap para copiar TP/SL
  tpCopyEl.addEventListener("click", ()=> copyPriceFrom(tpPriceEl));
  slCopyEl.addEventListener("click", ()=> copyPriceFrom(slPriceEl));

  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("./sw.js").catch(()=>{});
  }

  // Init
  calc();
</script>
</body>
</html>
