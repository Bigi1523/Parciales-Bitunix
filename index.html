<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Parciales Bitunix</title>

<meta name="theme-color" content="#0b1220">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Parciales">

<link rel="manifest" href="manifest.webmanifest">
<link rel="apple-touch-icon" href="icon-180.png">

<style>
  body{background:#0b1220;color:#e5e7eb;font-family:system-ui;padding:20px;margin:0;}
  .box{max-width:420px;margin:auto;background:#0f172a;border-radius:14px;padding:18px;}
  h1{font-size:16px;margin:0 0 12px;}

  label{font-size:12px;color:#9ca3af;}

  input{
    width:100%;margin:6px 0 12px;padding:12px;border-radius:12px;border:none;
    background:#020617;color:#fff;font-size:16px;
  }
  input::placeholder{color:#475569;}

  .seg{display:flex; gap:10px; margin:8px 0 14px;}

  /* Botón base */
  .btn{
    flex:1; padding:12px; border-radius:12px;
    border:1px solid #1f2937;
    background:#0b1220; color:#e5e7eb;
    cursor:pointer; user-select:none; text-align:center;
    font-weight:800;
  }
  .btn.active{
    background:#1f2937;
    border-color:#334155;
    box-shadow: 0 0 0 1px rgba(148,163,184,.25) inset;
  }

  /* Short/Long: colores */
  .btn.short{
    background:#1a0b0b;           /* rojo oscuro */
    border-color:#3b1a1a;
  }
  .btn.long{
    background:#0b1a10;           /* verde oscuro */
    border-color:#1a3b24;
  }
  .btn.short.active{
    background:#7f1d1d;           /* rojo claro (activo) */
    border-color:#ef4444;
    box-shadow: 0 0 0 1px rgba(239,68,68,.25) inset;
  }
  .btn.long.active{
    background:#166534;           /* verde claro (activo) */
    border-color:#22c55e;
    box-shadow: 0 0 0 1px rgba(34,197,94,.25) inset;
  }

  .result{background:#020617;border-radius:12px;padding:14px;margin-top:10px;}
  .small{font-size:12px;color:#9ca3af;}
  .big{font-size:22px;font-weight:900; font-variant-numeric: tabular-nums;}
  .hint{font-size:12px;color:#9ca3af;margin-top:10px;line-height:1.35;}

  .tp{color:#22c55e;}
  .sl{color:#ef4444;}

  .row{
    display:flex; gap:10px; align-items:stretch;
  }
  .copyBtn{
    padding:12px;
    border-radius:12px;
    border:1px solid #1f2937;
    background:#0b1220;
    color:#e5e7eb;
    font-weight:900;
    cursor:pointer;
    white-space:nowrap;
  }
  .copyBtn:active{transform:scale(0.99);}
  .toast{
    margin-top:8px;
    font-size:12px;
    color:#a7f3d0;
    min-height:16px;
  }
</style>
</head>
<body>
<div class="box">
  <h1>Parciales (Bitunix)</h1>

  <label>Lado</label>
  <div class="seg" id="sideSeg">
    <div class="btn short active" data-side="short">Short</div>
    <div class="btn long" data-side="long">Long</div>
  </div>

  <label>Precio de entrada</label>
  <!-- 1) Entrada vacía por defecto -->
  <input id="entry" type="number" inputmode="decimal" step="0.0001" placeholder="Ej: 223.59">

  <label>Margen (USDT)</label>
  <div class="seg" id="marginSeg">
    <div class="btn active" data-margin="50">50</div>
    <div class="btn" data-margin="75">75</div>
  </div>

  <label>Estrategia</label>
  <div class="seg" id="modeSeg">
    <div class="btn active" data-mode="ema8">EMA8</div>
    <div class="btn" data-mode="boll">Bollinger</div>
  </div>

  <div class="result" style="margin-top:6px;">
    <div class="small">Regla activa</div>
    <div class="big" id="ruleBadge">—</div>
  </div>

  <div class="result">
    <div class="small">Qty a cerrar (COPIAR EN BITUNIX)</div>

    <!-- 3) Botón copiar Qty -->
    <div class="row" style="margin-top:8px;">
      <div class="big" id="qtyClose" style="flex:1;">—</div>
      <button class="copyBtn" id="copyQtyBtn" type="button">Copiar Qty</button>
    </div>

    <div class="toast" id="toast"></div>
  </div>

  <div class="result">
    <div class="small">Precio TP (limit) <span class="tp">TP</span></div>
    <div class="big" id="tpPrice">—</div>
  </div>

  <div class="result">
    <div class="small">Precio SL (stop) <span class="sl">SL</span></div>
    <div class="big" id="slPrice">—</div>
  </div>

  <div class="hint" id="modeHint">—</div>
</div>

<script>
  const MODES = {
    ema8: { tpPct: 0.4, slPct: 0.4, partialPct: 60, lev: 30 },
    boll: { tpPct: 0.6, slPct: 0.5, partialPct: 50, lev: 20 }
  };

  let state = { side: "short", margin: 50, mode: "ema8" };

  const entryEl = document.getElementById("entry");
  const qtyCloseEl = document.getElementById("qtyClose");
  const tpPriceEl = document.getElementById("tpPrice");
  const slPriceEl = document.getElementById("slPrice");
  const hintEl = document.getElementById("modeHint");
  const ruleBadgeEl = document.getElementById("ruleBadge");
  const copyBtn = document.getElementById("copyQtyBtn");
  const toastEl = document.getElementById("toast");

  function setActive(containerId, attr, value){
    const box = document.getElementById(containerId);
    box.querySelectorAll(".btn").forEach(b=>{
      const v = b.getAttribute(attr);
      b.classList.toggle("active", v === value);
    });
  }

  function calc(){
    const entry = parseFloat(entryEl.value);

    // Si está vacío, no mostramos NaN, dejamos guiones
    if(!(entry>0)) {
      ruleBadgeEl.textContent = `${state.mode.toUpperCase()} | TP ${MODES[state.mode].tpPct}% | SL ${MODES[state.mode].slPct}% | Parcial ${MODES[state.mode].partialPct}% | Lev ${MODES[state.mode].lev}x`;
      qtyCloseEl.textContent = "—";
      tpPriceEl.textContent = "—";
      slPriceEl.textContent = "—";
      hintEl.textContent = `Side: ${state.side.toUpperCase()} | Margen: ${state.margin}`;
      return;
    }

    const cfg = MODES[state.mode];

    ruleBadgeEl.textContent =
      `${state.mode.toUpperCase()} | TP ${cfg.tpPct}% | SL ${cfg.slPct}% | Parcial ${cfg.partialPct}% | Lev ${cfg.lev}x`;

    const notional = state.margin * cfg.lev;
    const qtyTotal = notional / entry;
    const qtyClose = qtyTotal * (cfg.partialPct/100);

    const tpMove = cfg.tpPct/100;
    const slMove = cfg.slPct/100;

    let tpPrice, slPrice;
    if (state.side === "long") {
      tpPrice = entry * (1 + tpMove);
      slPrice = entry * (1 - slMove);
    } else {
      tpPrice = entry * (1 - tpMove);
      slPrice = entry * (1 + slMove);
    }

    qtyCloseEl.textContent = qtyClose.toFixed(6);
    tpPriceEl.textContent = tpPrice.toFixed(4);
    slPriceEl.textContent = slPrice.toFixed(4);

    hintEl.textContent = `Side: ${state.side.toUpperCase()} | Margen: ${state.margin} | Qty total: ${qtyTotal.toFixed(6)}`;
  }

  async function copyQty(){
    const text = qtyCloseEl.textContent.trim();
    if(text === "—" || !text) return;

    try {
      await navigator.clipboard.writeText(text);
      toastEl.textContent = "✅ Qty copiada";
    } catch (e) {
      // Fallback iOS antiguos
      const ta = document.createElement("textarea");
      ta.value = text;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand("copy");
      document.body.removeChild(ta);
      toastEl.textContent = "✅ Qty copiada";
    }

    setTimeout(()=> toastEl.textContent = "", 1200);
  }

  document.getElementById("sideSeg").addEventListener("click", (e)=>{
    const btn = e.target.closest(".btn"); if(!btn) return;
    state.side = btn.dataset.side;
    setActive("sideSeg","data-side", state.side);
    calc();
  });

  document.getElementById("marginSeg").addEventListener("click", (e)=>{
    const btn = e.target.closest(".btn"); if(!btn) return;
    state.margin = parseFloat(btn.dataset.margin);
    setActive("marginSeg","data-margin", String(state.margin));
    calc();
  });

  document.getElementById("modeSeg").addEventListener("click", (e)=>{
    const btn = e.target.closest(".btn"); if(!btn) return;
    state.mode = btn.dataset.mode;
    setActive("modeSeg","data-mode", state.mode);
    calc();
  });

  entryEl.addEventListener("input", ()=>{ toastEl.textContent=""; calc(); });
  copyBtn.addEventListener("click", copyQty);

  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("./sw.js").catch(()=>{});
  }

  calc();
</script>
</body>
</html>
